<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Declara√ß√£o de Resid√™ncia</title>
  <style>
    body {
      display: flex;
      font-family: Arial, sans-serif;
      margin: 0;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 25%;
      background: #f4f4f4;
      padding: 6px;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      box-sizing: border-box;
      display: none; /* oculta at√© descriptografar */
    }
    .sidebar h2 {
      margin-top: 20px;
      font-size: 18px;
      text-align: center;
    }
    .sidebar input[type="text"] {
      width: 90%;
      padding: 6px;
      margin-bottom: 10px;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .checkbox-container label {
      margin-left: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    td {
      padding: 6px;
      cursor: pointer;
    }
    tr:hover {
      background: #ddd;
    }
    .excluir-nomes {
      margin-top: 15px;
    }
    .excluir-nomes h3 {
      margin-bottom: 10px;
    }
    .excluir-nomes label {
      display: block;
      margin-bottom: 5px;
    }
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
      display: none; /* oculta at√© descriptografar */
    }
    button {
      padding: 10px 15px;
      font-size: 14px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #2980b9;
    }
    #manualForm {
      display: none;
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #fff;
      width: 90%;
      max-width: 400px;
    }
    /* Tela de senha */
    #loginScreen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #111;
      color: white;
      z-index: 999;
    }
    #loginScreen input {
      padding: 8px;
      margin-top: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Tela de senha -->
  <div id="loginScreen">
    <h2>üîí Acesso Restrito</h2>
    <p>Digite a senha para descriptografar os dados</p>
    <input type="password" id="senha" placeholder="Senha de acesso" />
    <button id="carregar">Desbloquear</button>
    <p id="status" style="color: #ccc; margin-top: 10px;"></p>
  </div>

  <!-- Interface principal -->
  <div class="sidebar">
    <h2>Emiss√£o de Declara√ß√£o de Resid√™ncia</h2>
    <input type="text" id="filtro" placeholder="Buscar paciente..." />
    <div class="checkbox-container">
      <input type="checkbox" id="cras" />
      <label for="cras"><span>Declara√ß√£o para o CRAS?</span></label>
    </div>
    <table id="tabelaPacientes"></table>
    <div class="excluir-nomes" id="listaNomes" style="display:none;">
      <h3>Nomes inclu√≠dos na Declara√ß√£o</h3>
      <div id="nomesIncluidos"></div>
    </div>
  </div>

  <div class="content">
    <button id="preencherManual">Preencher Manualmente</button>

    <div id="manualForm">
      <h3>Preencher Endere√ßo Manualmente</h3>
      <label>Nome:</label>
      <input type="text" id="manualNome" />
      <label>Tipo de Logradouro:</label>
      <select id="manualTipo">
        <option value="">SELECIONE</option>
        <option value="RUA">RUA</option>
        <option value="AVENIDA">AVENIDA</option>
        <option value="ALAMEDA">ALAMEDA</option>
        <option value="BECO">BECO</option>
      </select>
      <label>Logradouro:</label>
      <input type="text" id="manualLogradouro" />
      <label>N¬∫:</label>
      <input type="text" id="manualNumero" />
      <label>Complemento:</label>
      <input type="text" id="manualComplemento" />
      <label>Bairro:</label>
      <select id="manualBairro">
        <option value="DOM PEDRO I">DOM PEDRO I</option>
        <option value="QUINTA DOS IP√äS">QUINTA DOS IP√äS</option>
      </select>
      <button id="salvarManual">Salvar Paciente</button>
    </div>

    <button id="gerarPDF">Gerar Declara√ß√£o</button>
  </div>

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

  <script>
  // =====================
  // SE√á√ÉO 1: DESCRIPTOGRAFIA
  // =====================
  let pacientes = [];

  document.getElementById("carregar").addEventListener("click", async () => {
    const senha = document.getElementById("senha").value.trim();
    const status = document.getElementById("status");
    if (!senha) return alert("Digite a senha.");

    status.textContent = "Descriptografando...";

    try {
      const res = await fetch("dados_encrypted.txt");
      const base64Str = await res.text();

      const encryptedBytes = Uint8Array.from(atob(base64Str), c => c.charCodeAt(0));
      const salt = encryptedBytes.slice(0, 16);
      const iv = encryptedBytes.slice(16, 32);
      const ciphertext = encryptedBytes.slice(32);

      const keyMaterial = await crypto.subtle.importKey(
        "raw",
        new TextEncoder().encode(senha),
        { name: "PBKDF2" },
        false,
        ["deriveKey"]
      );

      const key = await crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt: salt,
          iterations: 1000000,
          hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-CBC", length: 256 },
        false,
        ["decrypt"]
      );

      const decryptedBuffer = await crypto.subtle.decrypt({ name: "AES-CBC", iv: iv }, key, ciphertext);
      const decoder = new TextDecoder();
      const plaintext = decoder.decode(decryptedBuffer);

      let cleaned = plaintext.trim();

// Se o texto come√ßa com "const pacientes", remove at√© o in√≠cio do array
if (cleaned.startsWith("const pacientes")) {
  const start = cleaned.indexOf("[");
  const end = cleaned.lastIndexOf("]");
  cleaned = cleaned.substring(start, end + 1);
}

pacientes = JSON.parse(cleaned); // converte para objeto JS

      // Remove a tela de login e exibe o conte√∫do
      document.getElementById("loginScreen").remove();
      document.querySelector(".sidebar").style.display = "block";
      document.querySelector(".content").style.display = "flex";

      inicializarSistema(); // ativa o restante do c√≥digo

    } catch (e) {
      console.error(e);
      status.textContent = "Erro: senha incorreta ou arquivo inv√°lido.";
    }
  });

  // =====================
  // SE√á√ÉO 2: SISTEMA PRINCIPAL (ativa ap√≥s descriptografia)
  // =====================
  function inicializarSistema() {
  let pacienteSelecionado = null;
  let nomesIncluidos = [];

  const tabela = document.getElementById("tabelaPacientes");
  const filtro = document.getElementById("filtro");
  const checkCRAS = document.getElementById("cras");
  const listaNomesDiv = document.getElementById("nomesIncluidos");
  const btnGerarPDF = document.getElementById("gerarPDF");
  const manualNome = document.getElementById("manualNome");
  const manualTipo = document.getElementById("manualTipo");
  const manualLogradouro = document.getElementById("manualLogradouro");
  const manualNumero = document.getElementById("manualNumero");
  const manualComplemento = document.getElementById("manualComplemento");
  const manualBairro = document.getElementById("manualBairro");

  function renderTabela(dados) {
    tabela.innerHTML = "";
    dados.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${p["NOME CIDAD√ÉO"]}</td>`;
      tr.onclick = () => {
        pacienteSelecionado = p;
        document.querySelectorAll("tr").forEach(el => (el.style.background = ""));
        tr.style.background = "#b3d9ff";
        if (checkCRAS.checked) toggleListaNomes();
      };
      tabela.appendChild(tr);
    });
  }

  renderTabela(pacientes);

  // Filtros
  document.getElementById("filtro").addEventListener("input", () => {
    const txt = document.getElementById("filtro").value.toLowerCase();
    renderTabela(pacientes.filter(p => p["NOME CIDAD√ÉO"].toLowerCase().includes(txt)));
  });

  // Lista de nomes inclu√≠dos
  function toggleListaNomes() {
    if (!pacienteSelecionado) return;
    const { "TIPO DE LOGRADOURO": tipo, "LOGRADOURO": log, "N√öMERO": num, "COMPLEMENTO": comp, "BAIRRO": bairro } = pacienteSelecionado;
    const nomes = pacientes.filter(p =>
      p["TIPO DE LOGRADOURO"] === tipo &&
      p["LOGRADOURO"] === log &&
      p["N√öMERO"] === num &&
      p["COMPLEMENTO"] === comp &&
      p["BAIRRO"] === bairro
    ).map(p => p["NOME CIDAD√ÉO"]);

    nomesIncluidos = nomes.map(n => ({ nome: n, manter: true }));
    const lista = document.getElementById("nomesIncluidos");
    lista.innerHTML = "";
    nomesIncluidos.forEach(n => {
      const lbl = document.createElement("label");
      const chk = document.createElement("input");
      chk.type = "checkbox"; chk.checked = true;
      chk.onchange = () => (n.manter = chk.checked);
      lbl.append(chk, " ", n.nome);
      lista.appendChild(lbl);
    });
    document.getElementById("listaNomes").style.display = "block";
  }

  checkCRAS.addEventListener("change", toggleListaNomes);

  // Preencher manual
  document.getElementById("preencherManual").addEventListener("click", () => {
    document.getElementById("manualForm").style.display =
      document.getElementById("manualForm").style.display === "none" ? "block" : "none";
  });

  // Salvar manual
  document.getElementById("salvarManual").addEventListener("click", () => {
    const nome = manualNome.value.trim();
    if (!nome) return alert("Preencha o nome!");
    pacienteSelecionado = {
      "NOME CIDAD√ÉO": nome,
      "TIPO DE LOGRADOURO": manualTipo.value.trim(),
      "LOGRADOURO": manualLogradouro.value.trim(),
      "N√öMERO": manualNumero.value.trim(),
      "COMPLEMENTO": manualComplemento.value.trim(),
      "BAIRRO": manualBairro.value
    };
    document.getElementById("manualForm").style.display = "none";
    alert("Dados inseridos manualmente!");
  });

  // Gerar PDF
  btnGerarPDF.addEventListener("click", async () => {
    if (!pacienteSelecionado) return alert("Selecione um paciente.");

    try {
      const pdfBytes = await fetch("dec.pdf").then(r => r.arrayBuffer());
      const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
      const page = pdfDoc.getPages()[0];
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
      const { height } = page.getSize();

      const { "NOME CIDAD√ÉO": nome, "TIPO DE LOGRADOURO": tipo, "LOGRADOURO": log, "N√öMERO": num, "COMPLEMENTO": comp, "BAIRRO": bairro } = pacienteSelecionado;

      let nomes = [nome];
      if (document.getElementById("cras").checked && nomesIncluidos.length > 0)
        nomes = nomesIncluidos.filter(n => n.manter).map(n => n.nome);

      const nomesFinal = nomes.join(", ");
      const dataFormatada = new Date().toLocaleDateString("pt-BR");
      const texto = `DECLARO QUE: ${nomesFinal}, RESIDE NO SEGUINTE ENDERE√áO: ${tipo} ${log}, N¬∫ ${num}, COMPLEMENTO ${comp}, BAIRRO ${bairro}, S√ÉO JOS√â DA LAPA-MG E EST√Å(√ÉO) CADASTRADO(A)(S) NO PSF DOM PEDRO I, UNIDADE III, SITUADO NA RUA JOS√â SABINO COELHO (ANTIGA RUA 8), N¬∞ 140, TEL: 2010-1188.
      
S√ÉO JOS√â DA LAPA-MG, ${dataFormatada}.`;

      // Desenho do texto justificado
      function drawJustifiedText(txt, x, y, maxWidth, lineHeight = 14) {
        const words = txt.split(/\s+/);
        let line = [];
        let lineWidth = 0;
        let offset = 0;
        words.forEach((word, i) => {
          const testLine = [...line, word].join(" ");
          const testWidth = font.widthOfTextAtSize(testLine, 12);
          if (testWidth > maxWidth && line.length > 0) {
            const spaceWidth = font.widthOfTextAtSize(" ", 12);
            const extraSpace = (maxWidth - lineWidth) / (line.length - 1 || 1);
            let xPos = x;
            line.forEach((w, j) => {
              page.drawText(w, { x: xPos, y: y - offset, size: 12, font });
              xPos += font.widthOfTextAtSize(w, 12) + spaceWidth + (j < line.length - 1 ? extraSpace : 0);
            });
            offset += lineHeight;
            line = [word];
            lineWidth = font.widthOfTextAtSize(word, 12);
          } else {
            line.push(word);
            lineWidth = testWidth;
          }
        });
        // √öltima linha
        page.drawText(line.join(" "), { x, y: y - offset, size: 12, font });
      }

      drawJustifiedText(texto, 70, height - 170, 450);

      const pdfBytesFinal = await pdfDoc.save();

      // Abrir em nova aba
      const blob = new Blob([pdfBytesFinal], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const novaJanela = window.open(url);
      if (novaJanela) {
        novaJanela.onload = () => novaJanela.print();
      }
    } catch (err) {
      console.error("Erro ao gerar declara√ß√£o:", err);
      alert("Erro ao gerar a declara√ß√£o.");
    }
  });
}
  </script>
</body>
</html>
