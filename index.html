<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Declaração de Residência</title>
  <style>
    body {
      display: flex;
      font-family: Arial, sans-serif;
      margin: 0;
      height: 100vh;
    }
    .sidebar {
      width: 25%;
      background: #f4f4f4;
      padding: 6px;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .sidebar h2 {
      margin-top: 20px;
      font-size: 18px;
      text-align: center;
    }
    .sidebar input[type="text"] {
      width: 90%;
      padding: 6px;
      margin-bottom: 10px;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .checkbox-container label {
      order: 2;
      margin-left: 8px;
    }
    #cras-label {
      display: flex;
      align-items: center;
    }
    #cras-label input[type="checkbox"] {
      order: 2;
    }
    #cras-label span {
      order: 1;
      margin-right: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    td {
      padding: 6px;
      cursor: pointer;
    }
    tr:hover {
      background: #ddd;
    }
    .excluir-nomes {
      margin-top: 15px;
    }
    .excluir-nomes h3 {
      margin-bottom: 10px;
    }
    .excluir-nomes label {
      display: block;
      margin-bottom: 5px;
    }
    .content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    button {
      padding: 10px 15px;
      font-size: 14px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #2980b9;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Emissão de Declaração de Residência</h2>
    <input type="text" id="filtro" placeholder="Buscar paciente..." />
    <div class="checkbox-container">
      <input type="checkbox" id="cras" />
      <label for="cras" id="cras-label"><span>Declaração para o CRAS?</span></label>
    </div>
    <table id="tabelaPacientes"></table>

    <!-- Lista de nomes para inclusão/exclusão -->
    <div class="excluir-nomes" id="listaNomes" style="display:none;">
      <h3>Nomes incluídos na Declaração</h3>
      <div id="nomesIncluidos"></div>
    </div>
  </div>
  <div class="content">
    <button id="gerarPDF">Gerar Declaração PDF</button>
  </div>

  <!-- Bibliotecas carregadas -->
  <script src="dados.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;
    const { PDFLib } = window; // Para usar PDFLib
    let pacienteSelecionado = null;
    let nomesIncluidos = [];

    const tabela = document.getElementById("tabelaPacientes");
    const filtro = document.getElementById("filtro");
    const checkCRAS = document.getElementById("cras");
    const listaNomesDiv = document.getElementById("nomesIncluidos");
    const listaContainer = document.getElementById("listaNomes");

    // Renderiza tabela
    function renderTabela(dados) {
      tabela.innerHTML = "";
      dados.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${p["NOME CIDADÃO"]}</td>`;
        tr.onclick = () => {
          pacienteSelecionado = p;
          document.querySelectorAll("tr").forEach(el => el.style.background = "");
          tr.style.background = "#b3d9ff";
        };
        tabela.appendChild(tr);
      });
    }

    renderTabela(pacientes);

    filtro.addEventListener("input", () => {
      const txt = filtro.value.toLowerCase();
      renderTabela(pacientes.filter(p => p["NOME CIDADÃO"].toLowerCase().includes(txt)));
    });

    // Atualizar lista de nomes incluídos
    function atualizarListaNomes() {
      listaNomesDiv.innerHTML = "";
      nomesIncluidos.forEach((n) => {
        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = n.manter;
        checkbox.onchange = () => {
          n.manter = checkbox.checked;
        };
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + n.nome));
        listaNomesDiv.appendChild(label);
      });
    }

    // Mostrar ou esconder lista de nomes
    function toggleListaNomes() {
      if (checkCRAS.checked) {
        if (pacienteSelecionado) {
          const { "TIPO DE LOGRADOURO": tipo, "LOGRADOURO": logradouro, "NÚMERO": numero, "COMPLEMENTO": compl, "BAIRRO": bairro } = pacienteSelecionado;
          const nomes = pacientes
            .filter(p => 
              p["TIPO DE LOGRADOURO"] === tipo &&
              p["LOGRADOURO"] === logradouro &&
              p["NÚMERO"] === numero &&
              p["COMPLEMENTO"] === compl &&
              p["BAIRRO"] === bairro
            )
            .map(p => p["NOME CIDADÃO"]);
          
          nomesIncluidos = nomes.map(n => ({ nome: n, manter: true }));
          
          document.getElementById("excluirTitulo").style.display = "block";
          document.getElementById("listaNomes").style.display = "block";
          atualizarListaNomes();
        }
      } else {
        document.getElementById("excluirTitulo").style.display = "none";
        document.getElementById("listaNomes").style.display = "none";
        nomesIncluidos = [];
      }
    }

    document.getElementById("cras").addEventListener("change", toggleListaNomes);

    // Cria o título na lista de nomes
    const tituloLista = document.createElement("h3");
    tituloLista.id = "excluirTitulo";
    tituloLista.innerText = "Nomes incluídos na Declaração";
    tituloLista.style.display = "none";
    document.querySelector(".excluir-nomes").insertBefore(tituloLista, listaNomesDiv);

    // Evento ao clicar na tabela
    document.getElementById("tabelaPacientes").addEventListener("click", () => {
      if (pacienteSelecionado && checkCRAS.checked) {
        toggleListaNomes();
      }
    });

    // Evento do botão gerar PDF
    document.getElementById("gerarPDF").addEventListener("click", async () => {
      if (!pacienteSelecionado) {
        alert("Selecione um paciente.");
        return;
      }

      try {
        const pdfBytes = await fetch("dec.pdf").then(r => r.arrayBuffer());
        const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
        const pages = pdfDoc.getPages();
        const page = pages[0];
        const { height } = page.getSize();

        // Carregar a fonte Helvetica padrão
        const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

        const { "NOME CIDADÃO": nome, "TIPO DE LOGRADOURO": tipo, "LOGRADOURO": logradouro, "NÚMERO": numero, "COMPLEMENTO": compl, "BAIRRO": bairro } = pacienteSelecionado;

        // Lista de nomes
        let nomes = [nome];
        if (checkCRAS.checked && nomesIncluidos.length > 0) {
          nomes = nomesIncluidos.filter(n => n.manter).map(n => n.nome);
        }
        const nomesFinal = nomes.join(", ");

        const hoje = new Date();
        const dataFormatada = hoje.toLocaleDateString("pt-BR");

       const texto =
  `DECLARO QUE: ${nomesFinal}, RESIDE NO SEGUINTE ENDEREÇO: ${tipo} ${logradouro}, Nº ${numero}, COMPLEMENTO ${compl}, BAIRRO ${bairro}, SÃO JOSÉ DA LAPA-MG E ESTÁ(ÃO) CADASTRADO(A)(S) NO PSF DOM PEDRO I, UNIDADE III, SITUADO NA RUA JOSÉ SABINO COELHO (ANTIGA RUA 8), N° 140, TEL: 2010-1188.\n` +
  `\nSÃO JOSÉ DA LAPA-MG, ${dataFormatada} .`;

        // Função para quebras e justificação do texto
        function drawJustifiedText(txt, x, y, maxWidth, lineHeight=14) {
          const words = txt.split(/\s+/);
          let line = [];
          let lineWidth = 0;
          let offset = 0;
          words.forEach((word, i) => {
            const testLine = [...line, word].join(" ");
            const testWidth = font.widthOfTextAtSize(testLine, 12);
            if (testWidth > maxWidth && line.length > 0) {
              // Desenha linha justificada
              const spaceWidth = font.widthOfTextAtSize(" ", 12);
              const extraSpace = (maxWidth - lineWidth) / (line.length - 1 || 1);
              let xPos = x;
              line.forEach((w, j) => {
                page.drawText(w, { x: xPos, y: y - offset, size: 12, font });
                xPos += font.widthOfTextAtSize(w, 12) + spaceWidth + (j < line.length - 1 ? extraSpace : 0);
              });
              offset += lineHeight;
              line = [word];
              lineWidth = font.widthOfTextAtSize(word, 12);
            } else {
              line = [...line, word];
              lineWidth = testWidth;
            }
          });
          // Última linha
          page.drawText(line.join(" "), { x, y: y - offset, size: 12, font });
        }

        // Inserir o texto no PDF
        drawJustifiedText(texto, 70, height - 170, 450);

        const pdfBytesFinal = await pdfDoc.save();
        const blob = new Blob([pdfBytesFinal], { type: "application/pdf" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "declaracao.pdf";
        link.click();
      } catch (err) {
        console.error("Erro ao gerar PDF:", err);
        alert("Erro ao gerar PDF. Verifique se o arquivo 'dec.pdf' está acessível.");
      }
    });
  </script>
</body>
</html>